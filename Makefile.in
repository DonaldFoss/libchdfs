LIBHADOP_DIR = ..
GTEST_DIR = /usr/local/src/gtest-1.6.0

CXX = g++
CXXFLAGS += -Isrc -Wall
CXXTESTFLAGS += -I${GTEST_DIR}/include -pthread

LIBGTEST = libgtest.a
LTLIBRARIES = libhadoop.so
MAKEFILE_CONFS = configure config.status config.log autom4te.cache/ Makefile

CONF_CLASS = conf/Configuration
FILESYSTEM_CLASS = fs/FileSystem
CLIENTPROTOCOL_CLASS = hdfs/protocol/ClientProtocol
FSCONSTANTSL_CLASS = hdfs/protocol/FSConstants
DFSCLIENT_CLASS = hdfs/DFSClient
INETSOCKETADDRESS_CLASS = net/InetSocketAddress
NETUTILS_CLASS = net/NetUtils
URI_CLASS = net/URI
NAMENODE_CLASS = server/namenode/NameNode
LOGGER_CLASS = util/Logger
STRING_UTILS_CLASS = util/StringUtils

OBJECTS = src/$(CONF_CLASS).o \
src/$(FILESYSTEM_CLASS).o \
src/$(CLIENTPROTOCOL_CLASS).o src/$(FSCONSTANTSL_CLASS).o src/$(DFSCLIENT_CLASS).o \
src/$(INETSOCKETADDRESS_CLASS).o src/$(NETUTILS_CLASS).o src/$(URI_CLASS).o \
src/$(NAMENODE_CLASS).o \
src/$(LOGGER_CLASS).o src/$(STRING_UTILS_CLASS).o
SOURCES = $(OBJECTS:.o=.cc)
HEADERS = $(OBJECTS:.o=.h)

TESTS = test/$(CONF_CLASS)Test.cc test/$(FILESYSTEM_CLASS)Test.cc  test/$(NAMENODE_CLASS)Test.cc
TEST_MAIN = test/test.cc

all: $(LTLIBRARIES)

$(LTLIBRARIES):  $(OBJECTS)
	$(CXX) $(CXXFLAGS) -shared -o $@ $?

$(OBJECTS): %.o: %.cc $(HEADERS) 
	$(CXX) -c $(CXXFLAGS) -o $@ $<
	
clean:
	rm -rf  *.log *.a *.so core*
	find . -name "*.o" | xargs rm -rf
	find . -name "*.gch" | xargs rm -rf

test: test.o
	./test.o

test.o: $(TEST_MAIN) $(LIBGTEST) $(TESTS) $(OBJECTS)
	$(CXX) $(CXXFLAGS) $(CXXTESTFLAGS) -o $@ $?
	
$(LIBGTEST):
	$(CXX) -I${GTEST_DIR}/include -I${GTEST_DIR} -c ${GTEST_DIR}/src/gtest-all.cc
	ar -rv  $@ gtest-all.o 
	
reMakefile: cleanMakefile
	autoconf
	./configure

cleanMakefile:
	rm -rf $(MAKEFILE_CONFS)
   	
.PHONY : all test clean reMakefile cleanMakefile
